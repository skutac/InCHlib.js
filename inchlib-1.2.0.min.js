var InCHlib;!function(e){InCHlib=function(t){var o=this;o.user_settings=t,o.target_element=e("#"+t.target);var n=o.target_element.width();o.target_element.css({position:"relative"}),o.settings={target:"YourOwnDivId",heatmap:!0,heatmap_header:!0,dendrogram:!0,metadata:!1,column_metadata:!1,column_metadata_row_height:8,column_metadata_colors:"RdLrBu",max_height:800,width:n,heatmap_colors:"Greens",heatmap_font_color:"black",heatmap_part_width:.7,column_dendrogram:!1,independent_columns:!0,metadata_colors:"Reds",highlight_colors:"Oranges",highlighted_rows:[],label_color:"#9E9E9E",count_column:!1,count_column_colors:"Reds",min_row_height:1,max_row_height:25,max_column_width:150,font:"Helvetica",draw_row_ids:!1,fixed_row_id_size:!1,max_percentile:100,min_percentile:0,middle_percentile:50,columns_order:[],alternative_data:!1,images_as_alternative_data:!1,images_path:{dir:"",ext:""},navigation_toggle:{color_scale:!0,distance_scale:!0,export_button:!0,filter_button:!0,hint_button:!0}},o.update_settings(t),o.settings.width=t.max_width&&t.max_width<n?t.max_width:o.settings.width,o.settings.heatmap_part_width=o.settings.heatmap_part_width>.9?.9:o.settings.heatmap_part_width,o.header_height=150,o.footer_height=70,o.dendrogram_heatmap_distance=5,o.events={row_onclick:function(){},row_onmouseover:function(){},row_onmouseout:function(){},dendrogram_node_onclick:function(){},column_dendrogram_node_onclick:function(){},dendrogram_node_highlight:function(){},column_dendrogram_node_highlight:function(){},dendrogram_node_unhighlight:function(){},column_dendrogram_node_unhighlight:function(){},heatmap_onmouseout:function(){},on_zoom:function(){},on_unzoom:function(){},on_columns_zoom:function(){},on_columns_unzoom:function(){},on_refresh:function(){},empty_space_onclick:function(){}},o.colors={YlGn:{start:{r:255,g:255,b:204},end:{r:35,g:132,b:67}},GnBu:{start:{r:240,g:249,b:232},end:{r:43,g:140,b:190}},BuGn:{start:{r:237,g:248,b:251},end:{r:35,g:139,b:69}},PuBu:{start:{r:241,g:238,b:246},end:{r:5,g:112,b:176}},BuPu:{start:{r:237,g:248,b:251},end:{r:136,g:65,b:157}},RdPu:{start:{r:254,g:235,b:226},end:{r:174,g:1,b:126}},PuRd:{start:{r:241,g:238,b:246},end:{r:206,g:18,b:86}},OrRd:{start:{r:254,g:240,b:217},end:{r:215,g:48,b:31}},Purples2:{start:{r:242,g:240,b:247},end:{r:106,g:81,b:163}},Blues:{start:{r:239,g:243,b:255},end:{r:33,g:113,b:181}},Greens:{start:{r:237,g:248,b:233},end:{r:35,g:139,b:69}},Oranges:{start:{r:254,g:237,b:222},end:{r:217,g:71,b:1}},Reds:{start:{r:254,g:229,b:217},end:{r:203,g:24,b:29}},Greys:{start:{r:247,g:247,b:247},end:{r:82,g:82,b:82}},PuOr:{start:{r:230,g:97,b:1},end:{r:94,g:60,b:153}},BrBG:{start:{r:166,g:97,b:26},end:{r:1,g:133,b:113}},RdBu:{start:{r:202,g:0,b:32},end:{r:5,g:113,b:176}},RdGy:{start:{r:202,g:0,b:32},end:{r:64,g:64,b:64}},BuYl:{start:{r:5,g:113,b:176},end:{r:250,g:233,b:42}},YlOrR:{start:{r:255,g:255,b:178},end:{r:227,g:26,b:28},middle:{r:204,g:76,b:2}},YlOrB:{start:{r:255,g:255,b:212},end:{r:5,g:112,b:176},middle:{r:204,g:76,b:2}},PRGn2:{start:{r:123,g:50,b:148},end:{r:0,g:136,b:55},middle:{r:202,g:0,b:32}},PiYG2:{start:{r:208,g:28,b:139},end:{r:77,g:172,b:38},middle:{r:255,g:255,b:178}},YlGnBu:{start:{r:255,g:255,b:204},end:{r:34,g:94,b:168},middle:{r:35,g:132,b:67}},RdYlBu:{start:{r:215,g:25,b:28},end:{r:44,g:123,b:182},middle:{r:255,g:255,b:178}},RdYlGn:{start:{r:215,g:25,b:28},end:{r:26,g:150,b:65},middle:{r:255,g:255,b:178}},BuWhRd:{start:{r:33,g:113,b:181},middle:{r:255,g:255,b:255},end:{r:215,g:25,b:28}},RdLrBu:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:44,g:123,b:182}},RdBkGr:{start:{r:215,g:25,b:28},middle:{r:0,g:0,b:0},end:{r:35,g:139,b:69}},RdLrGr:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:35,g:139,b:69}}},o.objects_ref={tooltip_label:new Kinetic.Label({opacity:1,listening:!1}),tooltip_tag:new Kinetic.Tag({fill:o.settings.label_color,pointerWidth:10,pointerHeight:10,lineJoin:"round",listening:!1}),tooltip_text:new Kinetic.Text({fontFamily:o.settings.font,fontSize:12,padding:8,fill:"white",fontStyle:"bold",listening:!1,align:"center",lineHeight:1.2}),node:new Kinetic.Line({stroke:"grey",strokeWidth:2,lineCap:"sqare",lineJoin:"round",listening:!1}),node_rect:new Kinetic.Rect({fill:"white",opacity:0}),icon_overlay:new Kinetic.Rect({width:32,height:32,opacity:0}),heatmap_value:new Kinetic.Text({fontFamily:o.settings.font,fill:o.settings.heatmap_font_color,fontStyle:"bold",listening:!1}),heatmap_line:new Kinetic.Line({lineCap:"butt",value:!1}),column_header:new Kinetic.Text({fontFamily:o.settings.font,fontStyle:"bold",fill:"black"}),count:new Kinetic.Text({fontSize:10,fill:"#6d6b6a",fontFamily:o.settings.font,fontStyle:"bold",listening:!1}),cluster_overlay:new Kinetic.Rect({fill:"white",opacity:.5}),cluster_border:new Kinetic.Line({stroke:"black",strokeWidth:1,dash:[6,2]}),icon:new Kinetic.Path({fill:"grey"}),rect_gradient:new Kinetic.Rect({x:0,y:80,width:100,height:20,fillLinearGradientStartPoint:{x:0,y:80},fillLinearGradientEndPoint:{x:100,y:80},stroke:"#D2D2D2",strokeWidth:"1px"}),image:new Kinetic.Image({stroke:"#D2D2D2",strokeWidth:1})},o.paths_ref={zoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",unzoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",lightbulb:"M15.5,2.833c-3.866,0-7,3.134-7,7c0,3.859,3.945,4.937,4.223,9.499h5.553c0.278-4.562,4.224-5.639,4.224-9.499C22.5,5.968,19.366,2.833,15.5,2.833zM15.5,28.166c1.894,0,2.483-1.027,2.667-1.666h-5.334C13.017,27.139,13.606,28.166,15.5,28.166zM12.75,25.498h5.5v-5.164h-5.5V25.498z"}},InCHlib.prototype._update_user_settings=function(t){for(var o,n=this,a={},r=0,i=Object.keys(t),_=i.length;_>r;r++)o=i[r],void 0!==n.user_settings[o]&&n.user_settings[o]!==t[o]&&n.user_settings[o]===!0?a[o]=!1:void 0===n.user_settings[o]&&(a[o]=t[o]);e.extend(n.settings,a)},InCHlib.prototype.read_data=function(e){var t=this;t.json=e,t.data=t.json.data;var o={};void 0!==e.metadata?(t.metadata=e.metadata,o.metadata=!0):o.metadata=!1,void 0!==e.column_dendrogram?(t.column_dendrogram=e.column_dendrogram,o.column_dendrogram=!0):o.column_dendrogram=!1,void 0!==e.column_metadata?(t.column_metadata=e.column_metadata,o.column_metadata=!0):o.column_metadata=!1,void 0!==t.json.alternative_data&&t.settings.alternative_data?t.alternative_data=t.json.alternative_data.nodes:o.alternative_data=!1,t._update_user_settings(o),t._add_prefix()},InCHlib.prototype.read_data_from_file=function(t){var o=this;e.ajax({type:"GET",url:t,dataType:"json",success:function(e){o.read_data(e)},async:!1})},InCHlib.prototype._add_prefix=function(){var e=this;if(e.data.nodes=e._add_prefix_to_data(e.data.nodes),e.settings.metadata){for(var t={},o=0,n=Object.keys(e.metadata.nodes),a=n.length;a>o;o++)id=[e.settings.target,n[o]].join("#"),t[id]=e.metadata.nodes[n[o]];e.metadata.nodes=t}if(e.settings.alternative_data){for(var r={},o=0,n=Object.keys(e.alternative_data),a=n.length;a>o;o++)id=[e.settings.target,n[o]].join("#"),r[id]=e.alternative_data[n[o]];e.alternative_data=r}e.column_dendrogram&&(e.column_dendrogram.nodes=e._add_prefix_to_data(e.column_dendrogram.nodes))},InCHlib.prototype._add_prefix_to_data=function(e){for(var t,o=this,n={},a=0,r=Object.keys(e),i=r.length;i>a;a++)t=[o.settings.target,r[a]].join("#"),n[t]=e[r[a]],void 0!==n[t].parent&&(n[t].parent=[o.settings.target,n[t].parent].join("#")),1!=n[t].count&&(n[t].left_child=[o.settings.target,n[t].left_child].join("#"),n[t].right_child=[o.settings.target,n[t].right_child].join("#"));return n},InCHlib.prototype._get_root_id=function(e){for(var t,o=0,n=Object.keys(e),a=n.length;a>o;o++)if(void 0===e[n[o]].parent){t=n[o];break}return t},InCHlib.prototype._get_dimensions=function(){var e,t,o,n=this,a={data:0,metadata:0,overall:0};if(n.settings.images_as_alternative_data)a.data=n.alternative_data[Object.keys(n.alternative_data)[0]].length;else for(o=0,t=Object.keys(n.data.nodes),len=t.length;o<len;o++)if(e=t[o],1==n.data.nodes[e].count){a.data=n.data.nodes[e].features.length;break}return n.settings.metadata&&(e=Object.keys(n.metadata.nodes)[0],a.metadata=n.metadata.nodes[e].length),a.overall=a.data+a.metadata,a},InCHlib.prototype._get_min_max_middle=function(e){var t,o,n=this,a=[],r=[];for(t=0,o=e.length;o>t;t++)r=r.concat(e[t].filter(function(e){return null!==e}));var o=r.length;return r.sort(function(e,t){return e-t}),a.push(n.settings.min_percentile>0?r[n._hack_round(o*n.settings.min_percentile/100)]:Math.min.apply(null,r)),a.push(n.settings.max_percentile<100?r[n._hack_round(o*n.settings.max_percentile/100)]:Math.max.apply(null,r)),a.push(50!=n.settings.middle_percentile?r[n._hack_round(o*n.settings.middle_percentile/100)]:r[n._hack_round((o-1)/2)]),a},InCHlib.prototype._get_data_min_max_middle=function(e,t){var o=this;void 0===t&&(t="column");var n,a,r,i,_,l=e[0].length;if("column"==t){for(_=[],n=0;l>n;n++)_.push([]);for(n=0;n<e.length;n++)for(a=0;l>a;a++)r=e[n][a],null!==r&&void 0!==r&&_[a].push(r)}else _=e.slice(0);var s,d,c,h={};for(n=0;n<_.length;n++)if(o._is_number(_[n][0]))_[n]=_[n].map(parseFloat),_[n].sort(function(e,t){return e-t}),i=_[n].length,d=o.settings.max_percentile<100?_[n][o._hack_round(i*o.settings.max_percentile/100)]:Math.max.apply(null,_[n]),s=o.settings.min_percentile>0?_[n][o._hack_round(i*o.settings.min_percentile/100)]:Math.min.apply(null,_[n]),c=50!=o.settings.middle_percentile?_[n][o._hack_round(i*o.settings.middle_percentile/100)]:_[n][o._hack_round((i-1)/2)],h[n]={min:s,max:d,middle:c};else{var u=o._get_hash_object(_[n]);s=0,d=o._hack_size(u)-1,c=d/2,h[n]={min:s,max:d,middle:c,str2num:u}}return h},InCHlib.prototype._get_hash_object=function(e){var t,o=0,n={};for(t=0;t<e.length;t++)void 0===n[e[t]]&&(n[e[t]]=o,o++);return n},InCHlib.prototype._get_max_length=function(e){var t=e.map(function(e){return(""+e).length}),o=Math.max.apply(Math,t);return o},InCHlib.prototype._get_max_value_length=function(){var e,t,o=this,n=o.data.nodes,a=0;if(o.settings.alternative_data)if(o.settings.images_as_alternative_data)a=0;else for(var r=0,i=Object.keys(o.alternative_data),_=i.length;_>r;r++){t=i[r],e=o.alternative_data[t];for(var l=0,s=e.length;s>l;l++)(""+e[l]).length>a&&(a=(""+e[l]).length)}else for(var r=0,i=Object.keys(n),_=i.length;_>r;r++)if(t=i[r],1==n[t].count){e=n[t].features;for(var l=0,s=e.length;s>l;l++)(""+e[l]).length>a&&(a=(""+e[l]).length)}if(o.settings.metadata){n=o.metadata.nodes;for(var r=0,i=Object.keys(n),_=i.length;_>r;r++){t=i[r],e=n[t];for(var l=0,s=e.length;s>l;l++)(""+e[l]).length>a&&(a=(""+e[l]).length)}}return a},InCHlib.prototype._preprocess_heatmap_data=function(){var e,t,o,n,a,r,i=this,_=[],l=0;for(e=0,t=Object.keys(i.data.nodes),n=t.length;n>e;e++)o=t[e],r=i.data.nodes[o],1==r.count&&(a=r.features,_.push([o]),_[l].push.apply(_[l],a),i.settings.metadata&&_[l].push.apply(_[l],i.metadata.nodes[o]),l++);return _},InCHlib.prototype._reorder_heatmap=function(e){var t=this;t.leaves_y_coordinates={},e++,t.ordered_by_index==e?t.heatmap_array.reverse():t.heatmap_array.sort(t._is_number(t.heatmap_array[0][e])?function(t,o){return null==t[e]?-1:null==o[e]?1:t[e]-o[e]}:function(t,o){return null==t[e]?-1:null==o[e]?1:t[e]>o[e]?1:t[e]<o[e]?-1:0});for(var o=t.pixels_for_leaf/2+t.header_height,n=0,a=t.heatmap_array.length;a>n;n++)t.leaves_y_coordinates[t.heatmap_array[n][0]]=o,o+=t.pixels_for_leaf;t.ordered_by_index=e},InCHlib.prototype.draw=function(){var e=this;e.zoomed_clusters={row:[],column:[]},e.last_highlighted_cluster=null,e.current_object_ids=[],e.current_column_ids=[],e.highlighted_rows_y=[],e.heatmap_array=e._preprocess_heatmap_data(),e.on_features={data:[],metadata:[],count_column:[]},e.column_metadata_rows=e.settings.column_metadata?e.column_metadata.features.length:0,e.column_metadata_height=e.column_metadata_rows*e.settings.column_metadata_row_height,e.settings.heatmap?(e.last_column=null,e.dimensions=e._get_dimensions(),e._set_heatmap_settings()):(e.dimensions={data:0,metadata:0,overall:0},e.settings.heatmap_header=!1,e.settings.column_dendrogram=!1),e._adjust_leaf_size(e.heatmap_array.length),e.settings.draw_row_ids?e._get_row_id_size():e.right_margin=100,e._adjust_horizontal_sizes(),e.top_heatmap_distance=e.header_height+e.column_metadata_height+e.settings.column_metadata_row_height/2,e.settings.column_dendrogram&&e.heatmap_header&&(e.footer_height=150),e.stage=new Kinetic.Stage({container:e.settings.target}),e.settings.height=e.heatmap_array.length*e.pixels_for_leaf+e.header_height+e.footer_height,e.stage.setWidth(e.settings.width),e.stage.setHeight(e.settings.height),e._draw_stage_layer(),e.settings.dendrogram?(e.timer=0,e._draw_dendrogram_layers(),e.root_id=e._get_root_id(e.data.nodes),e._draw_row_dendrogram(e.root_id),e.settings.column_dendrogram&&e.settings.dendrogram&&(e.column_root_id=e._get_root_id(e.column_dendrogram.nodes),e.nodes2columns=!1,e.columns_start_index=0,e._draw_column_dendrogram(e.column_root_id))):(e.settings.column_dendrogram=!1,e._reorder_heatmap(0),e.ordered_by_index=0),e.settings.images_as_alternative_data&&(e.path2image={},e.path2image_obj={},e.image_counter=0),e._draw_heatmap(),e._draw_heatmap_header(),e._draw_navigation(),e.highlight_rows(e.settings.highlighted_rows)},InCHlib.prototype._draw_dendrogram_layers=function(){var e=this;e.cluster_layer=new Kinetic.Layer,e.dendrogram_hover_layer=new Kinetic.Layer,e.stage.add(e.cluster_layer,e.dendrogram_hover_layer),e.cluster_layer.on("click",function(t){e.unhighlight_cluster(),e.unhighlight_column_cluster(),e.events.empty_space_onclick(t)})},InCHlib.prototype._draw_row_dendrogram=function(e){var t=this;t.dendrogram_layer=new Kinetic.Layer;var o=t.data.nodes[e],n=o.count;t.distance_step=t.distance/o.distance,t.leaves_y_coordinates={},t.objects2leaves={},t._adjust_leaf_size(n),t.settings.height=n*t.pixels_for_leaf+t.header_height+t.footer_height+t.column_metadata_height,t.stage.setWidth(t.settings.width),t.stage.setHeight(t.settings.height);var a=0,r=0,i=t.header_height+t.column_metadata_height+t.pixels_for_leaf/2;o.count>1&&(a=t.data.nodes[o.left_child].count,r=t.data.nodes[o.right_child].count),t._draw_row_dendrogram_node(e,o,a,r,0,i),t.middle_item_count=(t.min_item_count+t.max_item_count)/2,t._draw_distance_scale(o.distance),t.stage.add(t.dendrogram_layer),t._bind_dendrogram_hover_events(t.dendrogram_layer),t.dendrogram_layer.on("click",function(e){t._dendrogram_layers_click(this,e)}),t.dendrogram_layer.on("mousedown",function(e){t._dendrogram_layers_mousedown(this,e)}),t.dendrogram_layer.on("mouseup",function(e){t._dendrogram_layers_mouseup(this,e)})},InCHlib.prototype._draw_row_dendrogram_node=function(e,t,o,n,a,r){var i=this;if(1!=t.count){var _=i._get_node_neighbourhood(t,i.data.nodes),l=i.data.nodes[t.right_child],s=i.data.nodes[t.left_child],d=i._get_y1(_,o,n),c=i._get_y2(_,o,n),h=i._hack_round(i.distance-i.distance_step*t.distance);h=0==h?2:h;var u=h,g=i.distance-i.distance_step*i.data.nodes[t.left_child].distance,m=i.distance-i.distance_step*i.data.nodes[t.right_child].distance;1==l.count&&(c+=i.pixels_for_leaf/2),i.dendrogram_layer.add(i._draw_horizontal_path(e,h,d,u,c,g,m)),i._draw_row_dendrogram_node(t.left_child,s,o-_.left_node.right_count,n+_.left_node.right_count,g,d),i._draw_row_dendrogram_node(t.right_child,l,o+_.right_node.left_count,n-_.right_node.left_count,m,c)}else{var p=t.objects;i.leaves_y_coordinates[e]=r;for(var f=0,v=p.length;v>f;f++)i.objects2leaves[p[f]]=e;var y=t.objects.length;y<i.min_item_count&&(i.min_item_count=y),y>i.max_item_count&&(i.max_item_count=y)}},InCHlib.prototype._draw_stage_layer=function(){var e=this;e.stage_layer=new Kinetic.Layer;var t=new Kinetic.Rect({x:0,y:0,width:e.settings.width,height:e.settings.height,opacity:0});e.stage_layer.add(t),t.moveToBottom(),e.stage.add(e.stage_layer),e.stage_layer.on("click",function(t){e.unhighlight_cluster(),e.unhighlight_column_cluster(),e.events.empty_space_onclick(t)})},InCHlib.prototype._draw_column_dendrogram=function(e){var t=this;t.column_dendrogram_layer=new Kinetic.Layer,t.column_x_coordinates={};var o=t.column_dendrogram.nodes[e];t.current_column_count=o.count,t.vertical_distance=t.header_height,t.vertical_distance_step=t.vertical_distance/o.distance,t.last_highlighted_column_cluster=null;var n=t.column_dendrogram.nodes[o.left_child].count,a=t.column_dendrogram.nodes[o.right_child].count;t._draw_column_dendrogram_node(e,o,n,a,0,0),t.stage.add(t.column_dendrogram_layer),t.nodes2columns||(t.nodes2columns=t._get_nodes2columns()),t._bind_dendrogram_hover_events(t.column_dendrogram_layer),t.column_dendrogram_layer.on("click",function(e){t._column_dendrogram_layers_click(this,e)}),t.column_dendrogram_layer.on("mousedown",function(e){t._column_dendrogram_layers_mousedown(this,e)}),t.column_dendrogram_layer.on("mouseup",function(e){t._dendrogram_layers_mouseup(this,e)})},InCHlib.prototype._get_nodes2columns=function(){var e,t,o,n=this,a=[],r={},i={};for(o=0,keys=Object.keys(n.column_x_coordinates),len=keys.length;o<len;o++)e=keys[o],t=n.column_x_coordinates[e],r[t]=e,a.push(t);for(a.sort(function(e,t){return e-t}),o=0,len=a.length;o<len;o++)i[r[a[o]]]=o;return i},InCHlib.prototype._bind_dendrogram_hover_events=function(e){var t=this;e.on("mouseover",function(e){t._dendrogram_layers_mouseover(this,e)}),e.on("mouseout",function(e){t._dendrogram_layers_mouseout(this,e)})},InCHlib.prototype._delete_layers=function(e,t){for(var o=0,n=e.length;n>o;o++)void 0!==e[o]&&e[o].destroy();if(void 0!==t)for(var o=0,n=t.length;n>o;o++)t[o].removeChildren(),t[o].draw()},InCHlib.prototype._delete_all_layers=function(){var e=this;e.stage.destroyChildren()},InCHlib.prototype._adjust_leaf_size=function(e){var t=this;t.pixels_for_leaf=(t.settings.max_height-t.header_height-t.footer_height-t.column_metadata_height-5)/e,t.settings.draw_row_ids&&t.settings.fixed_row_id_size&&(t.settings.min_row_height=t.settings.fixed_row_id_size+2),t.pixels_for_leaf>t.settings.max_row_height&&(t.pixels_for_leaf=t.settings.max_row_height),t.settings.min_row_height>t.pixels_for_leaf&&(t.pixels_for_leaf=t.settings.min_row_height)},InCHlib.prototype._adjust_horizontal_sizes=function(e){var t=this;void 0===e&&(e=t._get_visible_count()),t.settings.dendrogram?(t.heatmap_width=t.settings.heatmap?(t.settings.width-t.right_margin-t.dendrogram_heatmap_distance)*t.settings.heatmap_part_width:0,t.pixels_for_dimension=e>0&&t.heatmap_width>0?t.heatmap_width/e:0,0===t.pixels_for_dimension&&(t.heatmap_width=0),t.distance=t.settings.width-t.heatmap_width-t.right_margin,t.heatmap_distance=t.distance+t.dendrogram_heatmap_distance):(t.heatmap_width=t.settings.width-t.right_margin,t.distance=t.right_margin/2,t.heatmap_distance=t.distance,t.pixels_for_dimension=e?t.heatmap_width/e:0),t.settings.max_column_width&&t.settings.max_column_width<t.pixels_for_dimension&&(t.pixels_for_dimension=t.settings.max_column_width,t.heatmap_width=e*t.pixels_for_dimension,t.settings.dendrogram?(t.distance=t.settings.width-t.heatmap_width-t.right_margin-t.dendrogram_heatmap_distance,t.heatmap_distance=t.distance+t.dendrogram_heatmap_distance):(t.distance=t._hack_round((t.settings.width-t.heatmap_width)/2),t.right_margin=t.distance,t.heatmap_distance=t.distance))},InCHlib.prototype._set_color_settings=function(){var e=this,t=[];for(i=0,keys=Object.keys(e.data.nodes),len=keys.length;i<len;i++)node=e.data.nodes[keys[i]],1==node.count&&t.push(node.features);if(e.data_descs={},e.settings.independent_columns)e.data_descs=e._get_data_min_max_middle(t);else{var o=e._get_min_max_middle(t);for(i=0;i<e.dimensions.data;i++)e.data_descs[i]={min:o[0],max:o[1],middle:o[2]}}if(e.settings.metadata){var n=[];for(i=0,keys=Object.keys(e.metadata.nodes),len=keys.length;i<len;i++)n.push(e.metadata.nodes[keys[i]]);e.metadata_descs=e._get_data_min_max_middle(n)}},InCHlib.prototype._set_heatmap_settings=function(){var e,t=this;for(t.header=[],e=0;e<t.dimensions.overall;e++)t.header.push("");if(0===t.settings.columns_order.length||t.settings.columns_order.length!==t.dimensions.data)for(t.settings.columns_order=[],e=0;e<t.dimensions.data;e++)t.settings.columns_order.push(e);if(t.settings.metadata)for(e=t.dimensions.data;e<t.dimensions.data+t.dimensions.metadata;e++)t.settings.columns_order.push(e);for(t.settings.count_column&&t.settings.columns_order.push(t.settings.columns_order.length),t.features={},e=0;e<t.settings.columns_order.length;e++)t.features[e]=!0;if(t._set_on_features(),t.heatmap_header=!1,t.metadata_header=!1,t.current_label=null,t._set_color_settings(),t.settings.alternative_data&&void 0!==t.json.alternative_data.feature_names?t.heatmap_header=t.json.alternative_data.feature_names:void 0!==t.data.feature_names&&(t.heatmap_header=t.data.feature_names),t.heatmap_header)for(e=0;e<t.dimensions.data;e++)t.header[e]=t.heatmap_header[t.on_features.data[e]];if(t.settings.metadata&&t.metadata.feature_names)for(t.metadata_header=t.metadata.feature_names,e=0;e<t.dimensions.metadata;e++)t.header[t.dimensions.data+e]=t.metadata_header[e];t.settings.column_metadata&&void 0!==t.column_metadata.feature_names&&(t.column_metadata_header=t.column_metadata.feature_names),t.settings.count_column&&(t.max_item_count=1,t.min_item_count=1,t.dimensions.overall++,t.header.push("Count")),t._adjust_horizontal_sizes(),t.top_heatmap_distance=t.header_height+t.column_metadata_height+t.settings.column_metadata_row_height/2},InCHlib.prototype._set_on_features=function(e){var t,o=this;if(void 0===e)for(var e=[],n=0,a=Object.keys(o.features),r=a.length;r>n;n++)t=a[n],o.features[t]&&e.push(o.settings.columns_order[n]);o.on_features={data:[],metadata:[],count_column:[]};for(var n=0,r=e.length;r>n;n++)t=e[n],t<o.dimensions.data?o.on_features.data.push(t):t<=o.dimensions.data+o.dimensions.metadata-1?o.on_features.metadata.push(t-o.dimensions.data):o.on_features.count_column.push(0)},InCHlib.prototype._draw_heatmap=function(){var e=this;if(e.settings.heatmap){var t,o;e.heatmap_layer=new Kinetic.Layer,e.heatmap_overlay=new Kinetic.Layer,e.current_draw_values=!0,e.max_value_length=e._get_max_value_length(),e.value_font_size=e._get_font_size(e.max_value_length,e.pixels_for_dimension,e.pixels_for_leaf,12),e.value_font_size<4&&(e.current_draw_values=!1);for(var n=e.heatmap_distance,a=0,r=Object.keys(e.leaves_y_coordinates),i=r.length;i>a;a++)key=r[a],o=e.leaves_y_coordinates[key],t=e._draw_heatmap_row(key,n,o),e.heatmap_layer.add(t),e._bind_row_events(t);if(e.settings.column_metadata){e.column_metadata_descs=e._get_data_min_max_middle(e.column_metadata.features,"row"),y1=e.header_height+.5*e.settings.column_metadata_row_height;for(var a=0,i=e.column_metadata.features.length;i>a;a++)t=e._draw_column_metadata_row(e.column_metadata.features[a],a,n,y1),e.heatmap_layer.add(t),e._bind_row_events(t),y1+=e.settings.column_metadata_row_height}e.settings.draw_row_ids&&e._draw_row_ids(),e.highlighted_rows_layer=new Kinetic.Layer,e.stage.add(e.heatmap_layer,e.heatmap_overlay,e.highlighted_rows_layer),e.highlighted_rows_layer.moveToTop(),e.row_overlay=e.objects_ref.heatmap_line.clone(),e.column_overlay=e.objects_ref.heatmap_line.clone(),e.heatmap_layer.on("mouseleave",function(t){e.last_header=null,e.heatmap_overlay.destroyChildren(),e.heatmap_overlay.draw(),e.events.heatmap_onmouseout(t)})}},InCHlib.prototype._draw_heatmap_row=function(e,t,o){for(var n,a,r,i,_,l,s,d,c=this,h=c.data.nodes[e],u=new Kinetic.Group({id:e}),g=0,m=c.on_features.data.length;m>g;g++){if(d=c.on_features.data[g],n=t+c.pixels_for_dimension,a=o,_=h.features[d],s=_,c.settings.alternative_data&&(s=c.alternative_data[e][d],c.settings.images_as_alternative_data&&void 0!==s&&null!==s&&""!=s)){_=null;var p=c.settings.images_path.dir+s+c.settings.images_path.ext;if(p=escape(p),void 0===c.path2image[s]){var f=new Image;f.src=p,f.onload=function(){c.image_counter++,c.image_counter===Object.keys(c.path2image).length&&c.heatmap_layer.draw()},c.path2image_obj[s]=f,c.path2image[s]=c.objects_ref.image.clone({image:c.path2image_obj[s]})}var v=c.path2image[s].clone({width:c.pixels_for_dimension,height:c.pixels_for_leaf,x:t,y:o-c._hack_round(.5*c.pixels_for_leaf),points:[t,o,t+c.pixels_for_dimension,null],column:["d",d].join("_"),value:s});u.add(v)}null===_||c.settings.images_as_alternative_data||(r=c._get_color_for_value(_,c.data_descs[d].min,c.data_descs[d].max,c.data_descs[d].middle,c.settings.heatmap_colors),i=c.objects_ref.heatmap_line.clone({stroke:r,points:[t,o,n,a],value:s,column:["d",d].join("_"),strokeWidth:c.pixels_for_leaf}),u.add(i),c.current_draw_values&&(l=c.objects_ref.heatmap_value.clone({x:c._hack_round((t+n)/2-(""+s).length*(c.value_font_size/4)),y:c._hack_round(o-c.value_font_size/2),fontSize:c.value_font_size,text:s}),u.add(l))),t=n}if(c.settings.metadata){var b=c.metadata.nodes[e];if(void 0!==b)for(var g=0,m=c.on_features.metadata.length;m>g;g++)d=c.on_features.metadata[g],_=b[d],n=t+c.pixels_for_dimension,a=o,null!==_&&void 0!==_&&(s=_,void 0!==c.metadata_descs[d].str2num&&(_=c.metadata_descs[d].str2num[_]),r=c._get_color_for_value(_,c.metadata_descs[d].min,c.metadata_descs[d].max,c.metadata_descs[d].middle,c.settings.metadata_colors),i=c.objects_ref.heatmap_line.clone({stroke:r,points:[t,o,n,a],value:s,column:["m",d].join("_"),strokeWidth:c.pixels_for_leaf}),u.add(i),c.current_draw_values&&(l=c.objects_ref.heatmap_value.clone({text:s,fontSize:c.value_font_size}),width=l.getWidth(),x=c._hack_round((t+n)/2-width/2),y=c._hack_round(o-c.value_font_size/2),l.position({x:x,y:y}),u.add(l))),t=n}if(c.settings.count_column&&c.features[c.dimensions.overall-1]){n=t+c.pixels_for_dimension;var w=h.objects.length;r=c._get_color_for_value(w,c.min_item_count,c.max_item_count,c.middle_item_count,c.settings.count_column_colors),i=c.objects_ref.heatmap_line.clone({stroke:r,points:[t,o,n,a],value:w,column:"Count",strokeWidth:c.pixels_for_leaf}),u.add(i),c.current_draw_values&&(l=c.objects_ref.heatmap_value.clone({text:w}),width=l.getWidth(),x=c._hack_round((t+n)/2-width/2),y=c._hack_round(o-c.value_font_size/2),l.position({x:x,y:y}),u.add(l))}return u},InCHlib.prototype._draw_column_metadata_row=function(e,t,o,n){for(var a,r,i,_,l,s,d,c=this,h=new Kinetic.Group({"class":"column_metadata"}),u=void 0===c.column_metadata_descs[t].str2num?!1:!0,g=0,m=c.on_features.data.length;m>g;g++)d=c.on_features.data[g],l=e[d],s=l,u&&(l=c.column_metadata_descs[t].str2num[l]),i=c._get_color_for_value(l,c.column_metadata_descs[t].min,c.column_metadata_descs[t].max,c.column_metadata_descs[t].middle,c.settings.column_metadata_colors),a=o+c.pixels_for_dimension,r=n,_=c.objects_ref.heatmap_line.clone({strokeWidth:c.settings.column_metadata_row_height,stroke:i,value:s,points:[o,n,a,r],column:["cm",t].join("_")}),h.add(_),o=a;return h},InCHlib.prototype._bind_row_events=function(e){var t=this;e.on("mouseenter",function(e){t._row_mouseenter(e)}),e.on("mouseleave",function(e){t._row_mouseleave(e)}),e.on("mouseover",function(e){t._draw_col_label(e)}),e.on("mouseout",function(){t.heatmap_overlay.find("#col_label")[0].destroy()}),e.on("click",function(e){var o=e.target.parent.attrs.id;if("column_metadata"!==e.target.parent.attrs["class"]){var n=t.data.nodes[o].objects,a=[];for(i=0;i<n.length;i++)a.push(n[i]);t.events.row_onclick(a,e)}})},InCHlib.prototype._draw_row_ids=function(){var e=this;if(!(e.pixels_for_leaf<6||e.row_id_size<5)){var t,o,n,a=[];for(t=0,keys=Object.keys(e.leaves_y_coordinates),len=keys.length;t<len;t++){if(leaf_id=keys[t],o=e.data.nodes[leaf_id].objects,o.length>1)return;a.push([o[0],e.leaves_y_coordinates[leaf_id]])}var r=e.distance+e._get_visible_count()*e.pixels_for_dimension+15;for(t=0;t<a.length;t++)n=e.objects_ref.heatmap_value.clone({x:r,y:e._hack_round(a[t][1]-e.row_id_size/2),fontSize:e.row_id_size,text:a[t][0],fontStyle:"italic",fill:"gray"}),e.heatmap_layer.add(n)}},InCHlib.prototype._get_row_id_size=function(){for(var e,t,o=this,n=[],a=0,r=o.heatmap_array.length;r>a;a++){if(t=o.heatmap_array[a][0],e=o.data.nodes[t].objects,e.length>1)return;n.push(e[0])}for(var i=o._get_max_length(n),_="",a=0;i>a;a++)_+="E";if(o.settings.fixed_row_id_size){var l=new Kinetic.Text({fontFamily:o.settings.font,fontSize:o.settings.fixed_row_id_size,fontStyle:"italic",listening:!1,text:_});o.row_id_size=o.settings.fixed_row_id_size,o.right_margin=20+l.width(),this.right_margin<100&&(o.right_margin=100)}else o.row_id_size=o._get_font_size(i,85,o.pixels_for_leaf,10),o.right_margin=100},InCHlib.prototype._draw_heatmap_header=function(){var e=this;if(e.settings.heatmap_header&&e.header.length>0){e.header_layer=new Kinetic.Layer;var t,o,n,a=e._hack_size(e.leaves_y_coordinates),r=e.settings.column_dendrogram&&e.heatmap_header?e.header_height+e.pixels_for_leaf*a+10+e.column_metadata_height:e.header_height-20,i=e.settings.column_dendrogram&&e.heatmap_header?45:-45,_=0,l=[];for(o=0,len=e.on_features.data.length;o<len;o++)l.push(e.header[e.on_features.data[o]]);for(o=0,len=e.on_features.metadata.length;o<len;o++)l.push(e.header[e.on_features.metadata[o]+e.dimensions.data]);e.settings.count_column&&e.features[e.dimensions.overall-1]&&l.push(e.header[e.dimensions.overall-1]);var s=e._get_max_length(l),d=e._get_font_size(s,e.header_height,e.pixels_for_dimension,16);if(8>d)return;for(o=0,len=l.length;o<len;o++)t=e.heatmap_distance+_*e.pixels_for_dimension+e.pixels_for_dimension/2,n=e.objects_ref.column_header.clone({x:t,y:r,text:l[o],position_index:o,fontSize:d,rotationDeg:i}),e.header_layer.add(n),_++;e.stage.add(e.header_layer),e.settings.dendrogram||(e.header_layer.on("click",function(t){var n=t.target,a=n.attrs.position_index;for(o=0;o<e.header_layer.getChildren().length;o++)e.header_layer.getChildren()[o].setFill("black");t.target.setAttrs({fill:"red"}),e._delete_layers([e.heatmap_layer,e.heatmap_overlay,e.highlighted_rows_layer]),e._reorder_heatmap(e._translate_column_to_feature_index(a)),e._draw_heatmap(),e.header_layer.draw()}),e.header_layer.on("mouseover",function(e){var t=e.target;t.setOpacity(.7),this.draw()}),e.header_layer.on("mouseout",function(e){var t=e.target;t.setOpacity(1),this.draw()}))}},InCHlib.prototype._translate_column_to_feature_index=function(e){for(var t,o=this,n=-1,a=0,r=Object.keys(o.features),i=r.length;i>a;a++)if(t=r[a],o.features[t]&&(n++,e===n))return t},InCHlib.prototype._draw_distance_scale=function(e){var t=this;if(t.settings.navigation_toggle.distance_scale){var o=t.header_height+t.column_metadata_height+t.settings.column_metadata_row_height/2-10,n=o,a=0,r=t.distance,i=new Kinetic.Line({points:[a,o,r,n],stroke:"black",listening:!1}),_=new Kinetic.Circle({x:r,y:n,radius:3,fill:"black",listening:!1}),l=0,s=3,d=r,c=t._hack_round(30/t.distance_step*10)/10,e=Math.round(100*t.distance/t.distance_step)/100,h=t._hack_round(t.distance_step*c),u=0,g=new Kinetic.Text({x:0,y:o-20,text:e,fontSize:12,fontFamily:t.settings.font,fontStyle:"bold",fill:"black",align:"right",listening:!1});t.dendrogram_layer.add(i,_,g),0==h&&(h=.5);var i;if(c>.1)for(;d>0;)i=new Kinetic.Line({points:[d,o-s,d,n+s],stroke:"black",listening:!1}),t.dendrogram_layer.add(i),l=t._hack_round(10*(l+c))/10,l>10&&(l=t._hack_round(l)),d-=h,u++}},InCHlib.prototype._draw_navigation=function(){var e=this;e.navigation_layer=new Kinetic.Layer;var t=0,o=10;if(e.settings.heatmap&&e._draw_color_scale(),e._draw_help(),!e.settings.column_dendrogram&&e.settings.heatmap&&e.settings.navigation_toggle.filter_button){var n=e.objects_ref.icon.clone({data:"M26.834,6.958c0-2.094-4.852-3.791-10.834-3.791c-5.983,0-10.833,1.697-10.833,3.791c0,0.429,0.213,0.84,0.588,1.224l8.662,15.002v4.899c0,0.414,0.709,0.75,1.583,0.75c0.875,0,1.584-0.336,1.584-0.75v-4.816l8.715-15.093h-0.045C26.625,7.792,26.834,7.384,26.834,6.958zM16,9.75c-6.363,0-9.833-1.845-9.833-2.792S9.637,4.167,16,4.167c6.363,0,9.834,1.844,9.834,2.791S22.363,9.75,16,9.75z",x:t,y:o,label:"Filter\ncolumns"}),a=e._draw_icon_overlay(t,o);
e.navigation_layer.add(n,a),t+=40,a.on("click",function(){e._filter_icon_click(this)}),a.on("mouseover",function(){e._icon_mouseover(n,a,e.navigation_layer)}),a.on("mouseout",function(){e._icon_mouseout(n,a,e.navigation_layer)})}if(e.zoomed_clusters.row.length>0||e.zoomed_clusters.column.length>0){var r=e.objects_ref.icon.clone({data:"M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z",x:t,y:o,id:"refresh_icon",label:"Refresh"}),i=e._draw_icon_overlay(t,o);e.navigation_layer.add(r,i),i.on("click",function(){e._refresh_icon_click(),e.events.on_refresh()}),i.on("mouseover",function(){e._icon_mouseover(r,i,e.navigation_layer)}),i.on("mouseout",function(){e._icon_mouseout(r,i,e.navigation_layer)})}if(e.zoomed_clusters.row.length>0){t=e.distance-55,o=e.header_height+e.column_metadata_height-40;var _=e.objects_ref.icon.clone({data:e.paths_ref.unzoom_icon,x:t,y:o,scale:{x:.7,y:.7},label:"Unzoom\nrows"}),l=e._draw_icon_overlay(t,o);e.navigation_layer.add(_,l),l.on("click",function(){e._unzoom_icon_click()}),l.on("mouseover",function(){e._icon_mouseover(_,l,e.navigation_layer)}),l.on("mouseout",function(){e._icon_mouseout(_,l,e.navigation_layer)})}if(e.zoomed_clusters.column.length>0){t=e.settings.width-85,o=e.header_height-50;var s=e.objects_ref.icon.clone({data:e.paths_ref.unzoom_icon,x:t,y:o-5,scale:{x:.7,y:.7},label:"Unzoom\ncolumns"}),d=e._draw_icon_overlay(t,o);e.navigation_layer.add(s,d),d.on("click",function(){e._column_unzoom_icon_click(this)}),d.on("mouseover",function(){e._icon_mouseover(s,d,e.navigation_layer)}),d.on("mouseout",function(){e._icon_mouseout(s,d,e.navigation_layer)})}if(e.settings.navigation_toggle.export_button){var c=e.objects_ref.icon.clone({data:"M24.25,10.25H20.5v-1.5h-9.375v1.5h-3.75c-1.104,0-2,0.896-2,2v10.375c0,1.104,0.896,2,2,2H24.25c1.104,0,2-0.896,2-2V12.25C26.25,11.146,25.354,10.25,24.25,10.25zM15.812,23.499c-3.342,0-6.06-2.719-6.06-6.061c0-3.342,2.718-6.062,6.06-6.062s6.062,2.72,6.062,6.062C21.874,20.78,19.153,23.499,15.812,23.499zM15.812,13.375c-2.244,0-4.062,1.819-4.062,4.062c0,2.244,1.819,4.062,4.062,4.062c2.244,0,4.062-1.818,4.062-4.062C19.875,15.194,18.057,13.375,15.812,13.375z",x:e.settings.width-62,y:10,scale:{x:.7,y:.7},id:"export_icon",label:"Export\nin png format"}),h=e._draw_icon_overlay(e.settings.width-62,10);e.navigation_layer.add(c,h),h.on("click",function(){e._export_icon_click(this)}),h.on("mouseover",function(){e._icon_mouseover(c,h,e.navigation_layer)}),h.on("mouseout",function(){e._icon_mouseout(c,h,e.navigation_layer)})}e.stage.add(e.navigation_layer)},InCHlib.prototype._draw_help=function(){var e=this;if(e.settings.navigation_toggle.hint_button){var t=e.objects_ref.icon.clone({data:e.paths_ref.lightbulb,x:e.settings.width-63,y:40,scale:{x:.8,y:.8},id:"help_icon",label:"Tip"}),o=e._draw_icon_overlay(e.settings.width-63,40);e.navigation_layer.add(t,o),o.on("mouseover",function(){e._icon_mouseover(t,o,e.navigation_layer),e._help_mouseover()}),o.on("mouseout",function(){e._help_mouseout(),e._icon_mouseout(t,o,e.navigation_layer)})}},InCHlib.prototype._draw_color_scale=function(){var e=this;if(e.settings.navigation_toggle.color_scale){var t=[e.settings.min_percentile/100,e._get_color_for_value(0,0,1,.5,e.settings.heatmap_colors),e.settings.middle_percentile/100,e._get_color_for_value(.5,0,1,.5,e.settings.heatmap_colors),e.settings.max_percentile/100,e._get_color_for_value(1,0,1,.5,e.settings.heatmap_colors)],o=e.objects_ref.rect_gradient.clone({label:"Color settings",fillLinearGradientColorStops:t,id:e.settings.target+"_color_scale"});o.on("mouseover",function(){e._color_scale_mouseover(o,e.navigation_layer)}),o.on("mouseout",function(){e._color_scale_mouseout(o,e.navigation_layer)}),o.on("click",function(){e._color_scale_click(o,e.navigation_layer)}),e.navigation_layer.add(o)}},InCHlib.prototype._update_color_scale=function(){var e=this,t=e.navigation_layer.find("#"+e.settings.target+"_color_scale");t.fillLinearGradientColorStops([e.settings.min_percentile/100,e._get_color_for_value(0,0,1,.5,e.settings.heatmap_colors),e.settings.middle_percentile/100,e._get_color_for_value(.5,0,1,.5,e.settings.heatmap_colors),e.settings.max_percentile/100,e._get_color_for_value(1,0,1,.5,e.settings.heatmap_colors)]),e.navigation_layer.draw()},InCHlib.prototype._draw_icon_overlay=function(e,t){var o=this;return o.objects_ref.icon_overlay.clone({x:e,y:t})},InCHlib.prototype._highlight_path=function(e,t){var o=this,n=o.data.nodes[e];1!=n.count?(o.dendrogram_layer.get("#"+e)[0].stroke(t),o._highlight_path(n.left_child,t),o._highlight_path(n.right_child,t)):(o.highlighted_rows_y.push(o.leaves_y_coordinates[e]),o.current_object_ids.push.apply(o.current_object_ids,n.objects))},InCHlib.prototype._highlight_column_path=function(e,t){var o=this,n=o.column_dendrogram.nodes[e];1!=n.count?(o.column_dendrogram_layer.get("#col"+e)[0].stroke(t),o._highlight_column_path(n.left_child,t),o._highlight_column_path(n.right_child,t)):o.current_column_ids.push(o.nodes2columns[e])},InCHlib.prototype.unhighlight_rows=function(){var e=this;e.highlight_rows([])},InCHlib.prototype.highlight_rows=function(e){var t,o,n,a=this;if(a.settings.heatmap){a.settings.highlighted_rows=e,a.highlighted_rows_layer.destroyChildren();var r=a.settings.heatmap_colors,i=a.settings.metadata_colors;a.settings.heatmap_colors=a.settings.highlight_colors,a.settings.metadata_colors=a.settings.highlight_colors;var _={},l=[];for(t=0;t<e.length;t++)void 0!==a.objects2leaves[e[t]]&&(n=a.objects2leaves[e[t]],void 0===_[n]&&(l.push(n),_[n]=null));for(t=0;t<l.length;t++)o=a._draw_heatmap_row(l[t],a.heatmap_distance,a.leaves_y_coordinates[l[t]]),a.highlighted_rows_layer.add(o),o.setAttr("listening",!1);a.highlighted_rows_layer.draw(),a.heatmap_overlay.moveToTop(),a.settings.heatmap_colors=r,a.settings.metadata_colors=i,a.highlighted_rows_layer.on("click",function(){a.heatmap_layer.fire("click")})}},InCHlib.prototype._highlight_cluster=function(e){var t=this,o=t.last_highlighted_cluster;o&&t.unhighlight_cluster(),o!==e&&(t.last_highlighted_cluster=e,t._highlight_path(e,"#F5273C"),t._draw_cluster_layer(e),t.events.dendrogram_node_highlight(t.current_object_ids,t._unprefix(e))),t.dendrogram_layer.draw()},InCHlib.prototype._highlight_column_cluster=function(e){var t=this,o=t.last_highlighted_column_cluster;o&&t.unhighlight_column_cluster(),o!==e&&(t.last_highlighted_column_cluster=e,t._highlight_column_path(e,"#F5273C"),t.current_column_ids.sort(function(e,t){return e-t}),t._draw_column_cluster_layer(e),t.events.column_dendrogram_node_highlight(t.current_column_ids,t._unprefix(e))),t.column_dendrogram_layer.draw()},InCHlib.prototype.unhighlight_column_cluster=function(){var e=this;e.last_highlighted_column_cluster&&(e._highlight_column_path(e.last_highlighted_column_cluster,"grey"),e.column_dendrogram_layer.draw(),e.column_cluster_group.destroy(),e.cluster_layer.draw(),e.current_column_ids=[],e.events.column_dendrogram_node_unhighlight(e._unprefix(e.last_highlighted_column_cluster)),e.last_highlighted_column_cluster=null)},InCHlib.prototype.highlight_cluster=function(e){var t=this;return t._highlight_cluster(t._prefix(e))},InCHlib.prototype.highlight_column_cluster=function(e){var t=this;return t._highlight_column_cluster(t._prefix(e))},InCHlib.prototype.unhighlight_cluster=function(){var e=this;e.last_highlighted_cluster&&(e._highlight_path(e.last_highlighted_cluster,"grey"),e.dendrogram_layer.draw(),e.row_cluster_group.destroy(),e.cluster_layer.draw(),e.events.dendrogram_node_unhighlight(e._unprefix(e.last_highlighted_cluster)),e.highlighted_rows_y=[],e.current_object_ids=[],e.last_highlighted_cluster=null)},InCHlib.prototype._neutralize_path=function(e){var t=this,o=t.data.nodes[e];if(1!=o.count){var n=t.dendrogram_layer.get("#"+e)[0];n&&(n.setStroke("grey"),t._neutralize_path(o.right_child),t._neutralize_path(o.left_child))}},InCHlib.prototype._draw_cluster_layer=function(e){var t=this;t.row_cluster_group=new Kinetic.Group;var o=t._get_visible_count(),n=t.data.nodes[e].count,a=t.distance-30,r=t.header_height+t.column_metadata_height-40,i=t.objects_ref.count.clone({x:a+10,y:r-10,text:n}),_=t.objects_ref.icon.clone({data:t.paths_ref.zoom_icon,x:a,y:r,scale:{x:.7,y:.7},label:"Zoom\nrows"}),l=t._draw_icon_overlay(a,r);a=t.distance+t.dendrogram_heatmap_distance;var s=o*t.pixels_for_dimension+t.heatmap_distance,d=t.highlighted_rows_y[0]-t.pixels_for_leaf/2,c=t.highlighted_rows_y[t.highlighted_rows_y.length-1]+t.pixels_for_leaf/2,h=t.objects_ref.cluster_overlay.clone({x:a,y:t.header_height+t.column_metadata_height+5,width:s,height:t._hack_round(d-t.header_height-t.column_metadata_height-5)}),u=t.objects_ref.cluster_border.clone({points:[0,d,s,d]}),g=t.objects_ref.cluster_overlay.clone({x:a,y:c,width:s,height:t.settings.height-c-t.footer_height+5}),m=t.objects_ref.cluster_border.clone({points:[0,c,s,c]});t.row_cluster_group.add(i,h,g,_,l,u,m),t.cluster_layer.add(t.row_cluster_group),t.stage.add(t.cluster_layer),i.moveToTop(),t.cluster_layer.draw(),t.navigation_layer.moveToTop(),l.on("mouseover",function(){t._icon_mouseover(_,l,t.cluster_layer)}),l.on("mouseout",function(){t._icon_mouseout(_,l,t.cluster_layer)}),l.on("click",function(){t._zoom_cluster(t.last_highlighted_cluster)})},InCHlib.prototype._draw_column_cluster_layer=function(e){var t=this;t.column_cluster_group=new Kinetic.Group;var o=t.column_dendrogram.nodes[e].count,n=t.settings.width-85,a=t.header_height-25,r=t.objects_ref.count.clone({x:n+15,y:a-5,text:o}),i=t.objects_ref.icon.clone({data:t.paths_ref.zoom_icon,x:n,y:a,scale:{x:.7,y:.7},label:"Zoom\ncolumns"}),_=t._draw_icon_overlay(n,a),l=t._hack_round((t.current_column_ids[0]-t.columns_start_index)*t.pixels_for_dimension),s=t._hack_round((t.current_column_ids[0]+t.current_column_ids.length-t.columns_start_index)*t.pixels_for_dimension),d=0,c=t.settings.height-t.footer_height+5,h=t.settings.height-t.footer_height-t.header_height+t.settings.column_metadata_row_height,u=t.objects_ref.cluster_border.clone({points:[t.heatmap_distance+l,d,t.heatmap_distance+l,c]}),g=t.objects_ref.cluster_overlay.clone({x:t.heatmap_distance,y:t.header_height,width:l,height:h}),m=t.objects_ref.cluster_border.clone({points:[t.heatmap_distance+s,d,t.heatmap_distance+s,c]}),p=t.objects_ref.cluster_overlay.clone({x:s+t.heatmap_distance,y:t.header_height,width:t.heatmap_width-s-(t.on_features.metadata.length+t.on_features.count_column.length)*t.pixels_for_dimension,height:h});t.column_cluster_group.add(g,p,i,_,r,u,m),t.cluster_layer.add(t.column_cluster_group),t.stage.add(t.cluster_layer),t.cluster_layer.draw(),t.navigation_layer.moveToTop(),_.on("mouseover",function(){t._icon_mouseover(i,_,t.cluster_layer)}),_.on("mouseout",function(){t._icon_mouseout(i,_,t.cluster_layer)}),_.on("click",function(){t._zoom_column_cluster(t.last_highlighted_column_cluster)})},InCHlib.prototype._draw_column_cluster=function(e){var t=this;t.columns_start_index=t.current_column_ids[0],t.on_features.data=t.current_column_ids;var o=t.distance;if(t._adjust_horizontal_sizes(),t._delete_layers([t.column_dendrogram_layer,t.heatmap_layer,t.heatmap_overlay,t.column_cluster_group,t.navigation_layer,t.highlighted_rows_layer],[t.dendrogram_hover_layer]),t.settings.heatmap_header&&t._delete_layers([t.header_layer]),t._draw_column_dendrogram(e),t._draw_heatmap(),t._draw_heatmap_header(),t._draw_navigation(),o!==t.distance){t._delete_layers([t.dendrogram_layer,t.cluster_layer]);var n=t.zoomed_clusters.row.length>0?t.zoomed_clusters.row[t.zoomed_clusters.row.length-1]:t.root_id;t._draw_row_dendrogram(n),null!==t.last_highlighted_cluster&&(t._highlight_path(t.last_highlighted_cluster,"#F5273C"),t.dendrogram_layer.draw(),t._draw_cluster_layer(t.last_highlighted_cluster))}else t.cluster_layer.moveToTop(),t.cluster_layer.draw()},InCHlib.prototype._zoom_column_cluster=function(e){var t=this;e!=t.column_root_id&&(t.zoomed_clusters.column.push(e),t._draw_column_cluster(e),t.highlight_rows(t.settings.highlighted_rows),t.events.on_columns_zoom(t.current_column_ids,t._unprefix(e)),t.current_column_ids=[],t.last_highlighted_column_cluster=null)},InCHlib.prototype._unzoom_column_cluster=function(){var e=this,t=e.zoomed_clusters.column.pop(),o=e.zoomed_clusters.column.length,n=o>0?e.zoomed_clusters.column[o-1]:e.column_root_id;e._get_column_ids(n),e._draw_column_cluster(n),e.events.on_columns_unzoom(e._unprefix(t)),e.current_column_ids=[],e._highlight_column_cluster(t)},InCHlib.prototype._draw_cluster=function(e){var t=this;t._delete_layers([t.dendrogram_layer,t.heatmap_layer,t.heatmap_overlay,t.cluster_layer,t.navigation_layer,t.header_layer,t.highlighted_rows_layer],[t.dendrogram_hover_layer]),t._draw_row_dendrogram(e),t._draw_heatmap(),t._draw_heatmap_header(),t._draw_navigation(),t.settings.column_dendrogram&&null!==t.last_highlighted_column_cluster&&t._draw_column_cluster_layer(t.last_highlighted_column_cluster)},InCHlib.prototype._zoom_cluster=function(e){var t=this;e!==t.root_id&&(t.zoomed_clusters.row.push(e),t._draw_cluster(e),t.highlight_rows(t.settings.highlighted_rows),t.events.on_zoom(t.current_object_ids,t._unprefix(e)),t.highlighted_rows_y=[],t.current_object_ids=[],t.last_highlighted_cluster=null)},InCHlib.prototype._unzoom_cluster=function(){var e=this,t=e.zoomed_clusters.row.pop(),o=e.zoomed_clusters.row.length,n=o>0?e.zoomed_clusters.row[o-1]:e.root_id;e._draw_cluster(n),e.events.on_unzoom(e._unprefix(t)),e._highlight_cluster(t)},InCHlib.prototype._get_node_neighbourhood=function(e,t){var o={left_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},right_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},left_count:t[e.left_child].count,right_count:t[e.right_child].count},n=t[e.left_child],a=t[e.right_child],r=t[n.left_child],i=t[n.right_child],_=t[a.left_child],l=t[a.right_child];return 1!=n.count&&(o.left_node.left_count=t[n.left_child].count,o.left_node.right_count=t[n.right_child].count,1!=r.count?(o.left_node.left_node.left_count=t[r.left_child].count,o.left_node.left_node.right_count=t[r.right_child].count):(o.left_node.left_node.left_count=.5,o.left_node.left_node.right_count=.5),1!=i.count?(o.left_node.right_node.left_count=t[i.left_child].count,o.left_node.right_node.right_count=t[i.right_child].count):(o.left_node.right_node.left_count=.5,o.left_node.right_node.right_count=.5)),1!=a.count&&(o.right_node.left_count=t[a.left_child].count,o.right_node.right_count=t[a.right_child].count,1!=_.count?(o.right_node.left_node.left_count=t[_.left_child].count,o.right_node.left_node.right_count=t[_.right_child].count):(o.right_node.left_node.left_count=.5,o.right_node.left_node.right_count=.5),1!=l.count?(o.right_node.right_node.left_count=t[l.left_child].count,o.right_node.right_node.right_count=t[l.right_child].count):(o.right_node.right_node.left_count=.5,o.right_node.right_node.right_count=.5)),o},InCHlib.prototype._draw_column_dendrogram_node=function(e,t,o,n){var a=this;if(t.count>1){var r=a._get_node_neighbourhood(t,a.column_dendrogram.nodes),i=a.column_dendrogram.nodes[t.right_child],_=a.column_dendrogram.nodes[t.left_child],l=a._get_x1(r,o,n),s=a._get_x2(r,o,n),d=a._hack_round(a.vertical_distance-a.vertical_distance_step*t.distance);d=0==d?2:d;var c=d;1==i.count&&(s-=a.pixels_for_dimension/2);var h=a.vertical_distance-a.vertical_distance_step*a.column_dendrogram.nodes[t.left_child].distance,u=a.vertical_distance-a.vertical_distance_step*a.column_dendrogram.nodes[t.right_child].distance;a.column_dendrogram_layer.add(a._draw_vertical_path(e,l,d,s,c,h,u)),a._draw_column_dendrogram_node(t.left_child,_,o-r.left_node.right_count,n+r.left_node.right_count,h,d),a._draw_column_dendrogram_node(t.right_child,i,o+r.right_node.left_count,n-r.right_node.left_count,u,c)}else a.column_x_coordinates[e]=n*a.pixels_for_dimension},InCHlib.prototype._get_y1=function(e,t){var o=this;t=t-e.left_node.right_count-e.left_node.left_node.right_count;var n=(t+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*o.pixels_for_leaf;return n+o.top_heatmap_distance},InCHlib.prototype._get_y2=function(e,t){var o=this;t+=e.right_node.left_node.left_count;var n=(t+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*o.pixels_for_leaf;return n+o.top_heatmap_distance},InCHlib.prototype._get_x1=function(e,t){var o=this;t=t-e.left_node.right_count-e.left_node.left_node.right_count;var n=(t+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*o.pixels_for_dimension;return o.heatmap_distance+o.on_features.data.length*o.pixels_for_dimension-n},InCHlib.prototype._get_x2=function(e,t){var o=this;t+=e.right_node.left_node.left_count;var n=(t+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*o.pixels_for_dimension;return o.heatmap_distance+o.on_features.data.length*o.pixels_for_dimension-n},InCHlib.prototype._draw_vertical_path=function(e,t,o,n,a,r,i){var _=this,l=new Kinetic.Group({}),s=_.objects_ref.node.clone({points:[t,r,t,o,n,a,n,i],id:"col"+e}),d=_.objects_ref.node_rect.clone({x:n-1,y:o-1,width:t-n+2,height:_.header_height-o,id:"col_rect"+e,path:s,path_id:e});return l.add(s,d),l},InCHlib.prototype._draw_horizontal_path=function(e,t,o,n,a,r,i){var _=this,l=new Kinetic.Group({}),s=_.objects_ref.node.clone({points:[r,o,t,o,n,a,i,a],id:e}),d=_.objects_ref.node_rect.clone({x:t-1,y:o-1,width:_.distance-t,height:a-o,id:[e,"rect"].join("_"),path:s,path_id:e});return l.add(s,d),l},InCHlib.prototype._filter_icon_click=function(){var t=this,o=t.target_element.find(".filter_features"),n="";if(o.length){o.fadeIn("fast");var a=t._draw_target_overlay()}else{filter_list="";for(var r in t.header)if(t.features[r]&&(n=""),r<t.dimensions){var i=t.header[r];""==i&&(i=parseInt(r)+1+". column"),filter_list=filter_list+"<li class='feature_switch' data-num='"+r+"'><span class='symbol'>"+n+"</span>  "+i+"</li>"}t.target_element.append("<div class='filter_features'><ul>"+filter_list+"</ul><hr /><div><span class='cancel_filter_list'>Cancel</span>&nbsp;&nbsp;&nbsp;<span class='update_filter_list'>Update</span></div></div>"),o=t.target_element.find(".filter_features"),o.css({display:"none",top:45,left:0,"border-radius":"5px","text-align":"center",position:"absolute","background-color":"#ffffff",border:"solid 2px #DEDEDE","padding-top":"5px","padding-left":"15px","padding-bottom":"10px","padding-right":"15px","font-weight":"bold","font-size":"14px","z-index":1e3,"font-family":t.settings.font}),o.find("ul").css({"list-style-type":"none","margin-left":"0","padding-left":"0","text-align":"left"}),o.find("li").css({color:"green","margin-top":"5px"}),o.find("div").css({cursor:"pointer",opacity:"0.7"});var a=t._draw_target_overlay();o.fadeIn("fast"),t.target_element.find(".feature_switch").click(function(){var o=parseInt(e(this).attr("data-num")),n=e(this).find("span");t.features[o]=!t.features[o],t.features[o]?(n.text(""),e(this).css("color","green")):(n.text(""),e(this).css("color","red")),t._set_on_features()}),e(function(){o.click(function(){return!1}),o.mousedown(function(){return!1}),e("#"+t.settings.target+" .filter_features ul li,#"+t.settings.target+" .filter_features div span").hover(function(){e(this).css({cursor:"pointer",opacity:"0.7"})},function(){e(this).css({cursor:"default",opacity:"1"})})}),t.target_element.find(".cancel_filter_list").click(function(){o.fadeOut("fast"),a.fadeOut("fast")}),a.click(function(){o.fadeOut("fast"),a.fadeOut("fast")}),t.target_element.find(".update_filter_list").click(function(){o.fadeOut("slow"),a.fadeOut("slow");var e=t.zoomed_clusters.row.length>0?t.zoomed_clusters.row[t.zoomed_clusters.row.length-1]:t.root_id,n=t.last_highlighted_cluster;t.last_highlighted_cluster=null,t._adjust_horizontal_sizes(),t._delete_all_layers(),t._draw_stage_layer(),t.settings.dendrogram&&(t._draw_dendrogram_layers(),t._draw_row_dendrogram(e),t._draw_dendrogram_layers(),t.settings.column_dendrogram&&t._visible_features_equal_column_dendrogram_count()&&t._draw_column_dendrogram(t.column_root_id)),t._draw_navigation(),t._draw_heatmap(),t._draw_heatmap_header(),null!=n&&t._highlight_cluster(n)})}},InCHlib.prototype._draw_target_overlay=function(){var t=this,o=t.target_element.find(".target_overlay");return o.length?o.fadeIn("fast"):(o=e("<div class='target_overlay'></div>"),o.css({"background-color":"white",position:"absolute",top:0,left:0,right:0,bottom:0,opacity:.5}),t.target_element.append(o)),o},InCHlib.prototype._refresh_icon_click=function(){var e=this;e.redraw()},InCHlib.prototype._export_icon_click=function(){function t(t){e('<a download="inchlib" href="'+t+'"></a>')[0].click()}function o(e){window.open(e,"_blank")}var n=this,a=n.target_element.find(".export_menu"),r=n._draw_target_overlay();if(a.length)a.fadeIn("fast");else{a=e("<div class='export_menu'><div><button type='submit' data-action='open'>Show image</button></div><div><button type='submit' data-action='save'>Save image</button></div></div>"),n.target_element.append(a),a.css({position:"absolute",top:45,left:n.settings.width-125,"font-size":"12px",border:"solid #D2D2D2 1px","border-radius":"5px",padding:"2px","background-color":"white"});var i=a.find("button");i.css({"padding-top":"7px","padding-bottom":"5px","padding-right":"8px","padding-left":"8px",color:"white",border:"solid #D2D2D2 1px",width:"100%","background-color":"#2171b5","font-weight":"bold"}),i.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})}),r.click(function(){a.fadeOut("fast"),r.fadeOut("fast")}),i.click(function(){var a=e(this).attr("data-action"),i=3,_=n.stage.width(),l=n.stage.height(),s=e("<h3 style='margin-top: 100px; margin-left: 100px; width: "+_+"px; height: "+l+"px;'>Loading...</h3>");n.target_element.after(s),n.target_element.hide(),n.stage.width(_*i),n.stage.height(l*i),n.stage.scale({x:i,y:i}),n.stage.draw(),n.navigation_layer.hide(),n.stage.toDataURL({quality:1,callback:function(e){"open"===a?o(e):t(e),n.stage.width(_),n.stage.height(l),n.stage.scale({x:1,y:1}),n.stage.draw(),s.remove(),n.target_element.show(),n.navigation_layer.show(),n.navigation_layer.draw(),r.trigger("click")}})})}},InCHlib.prototype._color_scale_click=function(){var t,o,n,a,r=this,i={heatmap_colors:"Heatmap data colors"},_={max_percentile:"Max percentile value",middle_percentile:"Middle percentile value",min_percentile:"Min percentile value"};r.settings.metadata&&(i.metadata_colors="Metadata colors"),r.settings.column_metadata&&(i.column_metadata_colors="Column metadata colors");var l="settings_form_"+r.settings.target,s=e("#"+l),d=r._draw_target_overlay();if(s.length)s.fadeIn("fast");else{s=e("<form class='settings_form' id='"+l+"'></form>");var c,h,u,g="";for(t=0,keys=Object.keys(i),len=keys.length;t<len;t++)n=keys[t],c=r._get_color_for_value(0,0,1,.5,r.settings[n]),h=r._get_color_for_value(.5,0,1,.5,r.settings[n]),u=r._get_color_for_value(1,0,1,.5,r.settings[n]),o="<div><div class='form_label'>"+i[n]+"</div><input type='text' name='"+n+"' value='"+r.settings[n]+"'/> <div class='color_button' style='background: linear-gradient(to right, "+c+","+h+","+u+")'></div></div>",g+=o;for(t=0,keys=Object.keys(_),len=keys.length;t<len;t++)n=keys[t],o="<div><div class='form_label'>"+_[n]+"</div><input type='text' name='"+n+"' value='"+r.settings[n]+"'/></div>",g+=o;o="<div><div class='form_label'>Heatmap coloring</div>                <select name='independent_columns'>",o+=r.settings.independent_columns?"<option value='true' selected>By columns</option>                  <option value='false'>Entire heatmap</option>":"<option value='true'>By columns</option>                  <option value='false' selected>Entire heatmap</option>",o+="</select></div>",g+=o,g+='<button type="submit">Redraw</button>',s.html(g),r.target_element.append(s),s.css({"z-index":1e3,position:"absolute",top:110,left:0,padding:"10px",border:"solid #D2D2D2 2px","border-radius":"5px","background-color":"white"}),e("#"+l+" .color_button").css({border:"solid #D2D2D2 1px",height:"15px",width:"30px",display:"inline-block"}),e("#"+l+" > div").css({"font-size":"12px","margin-bottom":"10px"}),e("#"+l+" input").css({"border-radius":"5px",width:"100px"}),e("#"+l+" .form_label").css({color:"gray","margin-bottom":"5px","font-style":"italic"}),e("#"+l+" button").css({"padding-top":"7px","padding-bottom":"5px","padding-right":"5px","padding-left":"5px",color:"white",border:"solid #D2D2D2 1px","border-radius":"5px",width:"100%","background-color":"#2171b5","font-weight":"bold"}),d.click(function(){s.fadeOut("fast"),d.fadeOut("fast")});var m=e("#"+l+" .color_button");m.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})}),m.click(function(e){r._draw_color_scales_select(this,e)}),s.submit(function(t){var i={},_=e(this).find("input, select");_.each(function(){o=e(this),n=o.attr("name"),a=o.val(),""!=a&&("true"===a?a=!0:"false"===a&&(a=!1),i[n]=a)}),r.update_settings(i),r.redraw_heatmap(),r._update_color_scale(),d.trigger("click"),t.preventDefault(),t.stopPropagation()})}},InCHlib.prototype._draw_color_scales_select=function(t){var o,n=this,a=n.target_element.find(".color_scales");if(a.length)a.fadeIn("fast"),o=a.find(".color_scale");else{a=e("<div class='color_scales'></div>");for(var r,i,_,l,s,d=0,c=Object.keys(n.colors),h=c.length;h>d;d++)s=c[d],i=n._get_color_for_value(0,0,1,.5,s),_=n._get_color_for_value(.5,0,1,.5,s),l=n._get_color_for_value(1,0,1,.5,s),r="<div class='color_scale' data-scale_acronym='"+s+"' style='background: linear-gradient(to right, "+i+","+_+","+l+")'></div>",a.append(r);n.target_element.append(a),a.css({border:"solid #D2D2D2 2px","border-radius":"5px",padding:"5px",position:"absolute",top:110,left:170,"background-color":"white"}),o=n.target_element.find(".color_scale"),o.css({"margin-top":"3px",width:"80px",height:"20px",border:"solid #D2D2D2 1px"}),o.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})}),n.target_element.find(".target_overlay").click(function(){a.fadeOut("fast")})}o.on("click",function(){{var r=e(this).attr("data-scale_acronym");e(t).prev("input:first").val(r)}e(t).css({background:"linear-gradient(to right, "+n._get_color_for_value(0,0,1,.5,r)+","+n._get_color_for_value(.5,0,1,.5,r)+","+n._get_color_for_value(1,0,1,.5,r)+")"}),a.fadeOut("fast"),o.off("click")})},InCHlib.prototype._color_scale_mouseover=function(e,t){var o=this,n=e.getAttr("label"),a=e.getAttr("x"),r=e.getAttr("y");o.icon_tooltip=o.objects_ref.tooltip_label.clone({x:a,y:r+25}),o.icon_tooltip.add(o.objects_ref.tooltip_tag.clone()),o.icon_tooltip.add(o.objects_ref.tooltip_text.clone({text:n})),t.add(o.icon_tooltip),o.icon_tooltip.moveToTop(),e.setOpacity(.7),t.draw()},InCHlib.prototype._color_scale_mouseout=function(e,t){var o=this;o.icon_tooltip.destroy(),e.setOpacity(1),t.draw()},InCHlib.prototype._unzoom_icon_click=function(){var e=this;e._unzoom_cluster()},InCHlib.prototype._column_unzoom_icon_click=function(){var e=this;e._unzoom_column_cluster()},InCHlib.prototype._icon_mouseover=function(e,t,o){var n=this;if("help_icon"!==e.getAttr("id")){var a=e.getAttr("label"),r=t.getAttr("x"),i=t.getAttr("y"),_=(t.getWidth(),t.getHeight());"export_icon"===e.getAttr("id")&&(r-=100,i-=50),n.icon_tooltip=n.objects_ref.tooltip_label.clone({x:r,y:i+1.2*_}),n.icon_tooltip.add(n.objects_ref.tooltip_tag.clone()),n.icon_tooltip.add(n.objects_ref.tooltip_text.clone({text:a})),o.add(n.icon_tooltip)}e.setFill("black"),o.draw()},InCHlib.prototype._icon_mouseout=function(e,t,o){var n=this;"help_icon"!==e.getAttr("id")&&n.icon_tooltip.destroy(),e.setFill("grey"),o.draw()},InCHlib.prototype._help_mouseover=function(){var t=this,o=t.target_element.find(".inchlib_help");o.length?o.show():(o=e("<div class='inchlib_help'><ul><li>Zoom clusters by a long click on a dendrogram node.</li></ul></div>"),o.css({position:"absolute",top:70,left:t.settings.width-200,"font-size":12,"padding-right":15,width:200,"background-color":"white","border-radius":5,border:"solid #DEDEDE 2px","z-index":1e3}),t.target_element.append(o))},InCHlib.prototype._help_mouseout=function(){var e=this;e.target_element.find(".inchlib_help").hide()},InCHlib.prototype._dendrogram_layers_click=function(e,t){var o=this,n=t.target.attrs.path_id;e.fire("mouseout",e,t),o._highlight_cluster(n),o.events.dendrogram_node_onclick(o.current_object_ids,o._unprefix(n),t)},InCHlib.prototype._column_dendrogram_layers_click=function(e,t){var o=this,n=t.target.attrs.path_id;e.fire("mouseout",e,t),o._highlight_column_cluster(n),o.events.column_dendrogram_node_onclick(o.current_column_ids,o._unprefix(n),t)},InCHlib.prototype._dendrogram_layers_mousedown=function(e,t){var o=this,n=t.target.attrs.path_id;clearTimeout(o.timer),o.timer=setTimeout(function(){o._get_object_ids(n),o._zoom_cluster(n)},500)},InCHlib.prototype._column_dendrogram_layers_mousedown=function(e,t){var o=this,n=t.target.attrs.path_id;clearTimeout(o.timer),o.timer=setTimeout(function(){o._get_column_ids(n),o._zoom_column_cluster(n)},500)},InCHlib.prototype._dendrogram_layers_mouseup=function(){var e=this;clearTimeout(e.timer)},InCHlib.prototype._dendrogram_layers_mouseout=function(){var e=this;e.path_overlay.destroy(),e.dendrogram_hover_layer.draw()},InCHlib.prototype._dendrogram_layers_mouseover=function(e,t){var o=this;o.path_overlay=t.target.attrs.path.clone({strokeWidth:4}),o.dendrogram_hover_layer.add(o.path_overlay),o.dendrogram_hover_layer.draw()},InCHlib.prototype._visible_features_equal_column_dendrogram_count=function(){var e=this;return e.on_features.data.length+e.on_features.metadata.length==e.current_column_count?!0:!1},InCHlib.prototype._get_color_for_value=function(e,t,o,n,a){var r=this,i=r.colors[a],_=i.start,l=i.end;if(e>o)return"rgb("+l.r+","+l.g+","+l.b+")";if(t==o||t>e)return"rgb("+_.r+","+_.g+","+_.b+")";void 0!==i.middle&&(e>=n?(t=n,_=i.middle,l=i.end):(o=n,_=i.start,l=i.middle));var s=(e-t)/(o-t),d=r._hack_round(_.r+s*(l.r-_.r)),c=r._hack_round(_.g+s*(l.g-_.g)),h=r._hack_round(_.b+s*(l.b-_.b));return"rgb("+d+","+c+","+h+")"},InCHlib.prototype._get_font_size=function(e,t,o,n){var a=o-2,r=a;return r/2*e>t-10&&(r/=r/2*e/(t-10)),r=r>a?a:r,r=r>n?n:r},InCHlib.prototype._get_object_ids=function(e){var t=this;t.current_object_ids=[],t._collect_object_ids(e)},InCHlib.prototype._collect_object_ids=function(e){var t=this;void 0!==t.data.nodes[e].left_child?(t._collect_object_ids(t.data.nodes[e].left_child),t._collect_object_ids(t.data.nodes[e].right_child)):t.current_object_ids.push.apply(t.current_object_ids,t.data.nodes[e].objects)},InCHlib.prototype._get_column_ids=function(e){var t=this;t.current_column_ids=[],t._collect_column_ids(e),t.current_column_ids.sort(function(e,t){return e-t})},InCHlib.prototype._collect_column_ids=function(e){var t=this;void 0!==t.column_dendrogram.nodes[e].left_child?(t._collect_column_ids(t.column_dendrogram.nodes[e].left_child),t._collect_column_ids(t.column_dendrogram.nodes[e].right_child)):t.current_column_ids.push(t.nodes2columns[e])},InCHlib.prototype._hack_size=function(e){return Object.keys(e).length},InCHlib.prototype._hack_round=function(e){return.5+e>>0},InCHlib.prototype._is_number=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},InCHlib.prototype._row_mouseenter=function(e){{var t=this,o=e.target.parent.getAttr("id");t._get_visible_count()}if("column_metadata"!==e.target.parent.attrs["class"]){t.highlighted_row=o;var n=t.leaves_y_coordinates[o],a=t.heatmap_distance;t.row_overlay=t.objects_ref.heatmap_line.clone({points:[a,n,a+t.heatmap_width,n],strokeWidth:t.pixels_for_leaf,stroke:"#FFFFFF",opacity:.3,listening:!1}),t.heatmap_overlay.add(t.row_overlay),t.heatmap_overlay.draw(),t.events.row_onmouseover(t.data.nodes[o].objects,e)
}},InCHlib.prototype._row_mouseleave=function(e){var t=this;t.row_overlay.destroy(),t.events.row_onmouseout(e)},InCHlib.prototype._draw_col_label=function(e){var t=this,o=e.target.attrs,n=o.points,a=t._hack_round((n[0]+n[2])/2),r=n[1]-.5*t.pixels_for_leaf,i=o.column.split("_"),_={d:t.heatmap_header[i[1]],m:t.metadata_header[i[1]],Count:"Count"};void 0!==t.column_metadata_header&&(_.cm=t.column_metadata_header[i[1]]);var l=o.value,s=_[i[0]];s!==t.last_column&&(t.column_overlay.destroy(),t.last_column=o.column,t.column_overlay=t.objects_ref.heatmap_line.clone({points:[a,t.header_height,a,t.header_height+t.column_metadata_height+(t.heatmap_array.length+.5)*t.pixels_for_leaf],strokeWidth:t.pixels_for_dimension,stroke:"#FFFFFF",opacity:.3,listening:!1}),t.heatmap_overlay.add(t.column_overlay)),void 0!==s&&(l=[s,l].join("\n"));var d=t.objects_ref.tooltip_label.clone({x:a,y:r,id:"col_label"});d.add(t.objects_ref.tooltip_tag.clone({pointerDirection:"down"}),t.objects_ref.tooltip_text.clone({text:l})),t.heatmap_overlay.add(d),t.heatmap_overlay.moveToTop(),t.heatmap_overlay.draw()},InCHlib.prototype._unprefix=function(e){var t=this;return e.split(t.settings.target+"#")[1]},InCHlib.prototype._prefix=function(e){var t=this;return t.settings.target+"#"+e},InCHlib.prototype.get_features_for_object=function(e){var t=this;if(void 0!==t.objects2leaves[e]){var o=t.objects2leaves[e];return t.data.nodes[o].features}return!1},InCHlib.prototype.add_color_scale=function(e,t){var o=this;o.colors[e]=t,o.target_element.find(".color_scales").remove()},InCHlib.prototype._get_visible_count=function(){var e=this;return e.on_features.data.length+e.on_features.metadata.length+e.on_features.count_column.length},InCHlib.prototype.update_settings=function(t){var o=this,n=o.settings.navigation_toggle;e.extend(o.settings,t),void 0!==t.navigation_toggle&&(o.settings.navigation_toggle=n,e.extend(o.settings.navigation_toggle,t.navigation_toggle))},InCHlib.prototype.redraw=function(){var e=this;e._delete_all_layers(),e.draw()},InCHlib.prototype.redraw_heatmap=function(){var e=this;e._delete_layers([e.heatmap_layer,e.heatmap_overlay,e.highlighted_rows_layer,e.header_layer]),e._set_color_settings(),e._draw_heatmap(),e._draw_heatmap_header(),e.heatmap_layer.moveToBottom(),e.heatmap_layer.moveUp()}}(jQuery);